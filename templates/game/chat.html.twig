{% extends 'base.html.twig' %}

{% block title %}Game{% endblock %}

{% block body %}
<style>
    body{
        background-color: rgb(66, 63, 57);
        height: 100%;
        width: 100%
    }
    .body-wrapper {
        height: 100%;
        padding: 5%;
        background-color: rgb(166, 147, 111);
        margin: 1em auto; 
        max-width: 800px; 
        width: 95%; 
        font: 18px/1.5 sans-serif;
        display: flex;
        flex-direction: row;
        justify-content: space-evenly;
    }
    .bground h1{
        color: rgb(237, 216, 202);
        font: italic 3em "Fira Sans", serif;
    }

    .bground h2, h3, h4, h5, h6{
        color: rgb(66, 63, 57);
        font: italic 2em "Fira Sans", serif;
    }
    .bground h3, h4, h5, h6{
        color: rgb(66, 63, 57);
        font: italic 1.5em "Fira Sans", serif;
    }
    .bground h6{
        font: italic 1em "Fira Sans", serif;
    }
    .bground h2 strong{
        font: italic 0.6em "Fira Sans", serif;
    }
    h1, h2 {
        text-align: center;
    }
    .chat-box {
        padding: 10px;
        height: 300px;
        width: 300px;
        background-color: rgb(237, 216, 202);
        border-radius: 2% 2% 0 0 ;
    }
    .chat-messages {
        height: 100%;
        overflow: auto;
    }

    .chat-btns{
        width: 300px;
        display: flex;
        flex-direction: row;
    }
    .chat-btns{
        width: 300px;
        display: flex;
        flex-direction: row;
    }
    .scenario{
        width: 400px;
        padding: 10px;
    }
    .scenario-btns{
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .scenario-btn{
        margin: 2px;
        background-color: rgb(66, 63, 57);
        color: rgb(237, 216, 202);
        border: rgb(237, 216, 202) solid 1px;
        
    }
    .scenario-btn:hover{
        background-color: rgb(237, 216, 202);
        color: rgb(66, 63, 57);
        border: rgb(66, 63, 57) solid 1px;   
    }
    .context{
        font: italic 0.9em "Fira Sans", serif;
        text-align: justify;
    }
    .chat-input{
        width: 70%;
    }
    .chat-btn{
        width: 30%;
        background-color: rgb(66, 63, 57);
        color: rgbrgb(237, 216, 202);
    }
    .chat-btn:hover{
        width: 30%;
        background-color: rgb(237, 216, 202);
        color: rgb(66, 63, 57);
    }
    .chat-message-title{
        border-bottom: 1px solid rgb(166, 147, 111);
        padding: 1%;
        width: 100%;
        text-align:center;
    }
</style>

<div class="bground">
    <h1>Page de jeu de <strong id="user">{{ user.username }}</strong></h1>
    <div class="body-wrapper">
        <div class="chat">
            <h2>Chat <strong id="chat-id">{{ chat.id }}</strong></h2>
            <div class="chat-box"> 
                <h6 class="chat-message-title"> Messages </h3>
                <div class="chat-messages" id="messages">

                </div>
            </div>
            <div class="chat-btns">
                <input class="form-control chat-input" type="text" id="message-content" placeholder="Tapez message ici " />
                <button class="btn btn-success chat-btn" id="send">Envoyer</button>
            </div>
        </div>
        
        <div class="scenario">
            <h2>Scénario</h2>
            <div id="scenario-context" class="context">
            </div>
            <div id="scenario-btn" class="scenario-btns">
            </div>
        </div>
    </div>
</div>
<div class="col-md-8">

<script>
    var COMPAIGN = {
        "1": {
            "context": "Vous entrez dans une caverne, vos yeux s'habituent tout juste à l'obscurité, que faites-vous ?",
            "buttons": [
                {
                    "id": 1,
                    "text": "On fouille",
                    "link": "2",
                },
                {
                    "id": 2,
                    "text": "On sort",
                    "link": "3",
                },
                {
                    "id": 3,
                    "text": "On fonce",
                    "link": "4",
                },
            ],
        },
        "2": {
            "context": "Il y a des chauves-souris et un ruisseau proches de vous, plus loin la caverne continue, où allez vous ?",
            "buttons": [
                {
                    "id": 1,
                    "text": "Proche des chauves-souris",
                    "link": "7",
                },
                {
                    "id": 2,
                    "text": "Proche du ruisseau",
                    "link": "8",
                },
                {
                    "id": 3,
                    "text": "On continue dans la caverne",
                    "link": "4",
                },
            ],
        },
        "3": {
            "context": "Avez-vous si peur que ça ? il n'y a rien dehors, que faites-vous ?",
            "buttons": [
                {
                    "id": 1,
                    "text": "On retourne dans la caverne",
                    "link": "1",
                },
                {
                    "id": 2,
                    "text": "Abandonner",
                    "link": "-1",
                }
             ],
        },
        "4": {
            "context": "Alors que vous avancez dans la caverne, vous voyez un trésor au loin, que faites-vous ?",
            "buttons": [
                {
                    "id": 4,
                    "text": "C'est surement un piège, on fait demi-tour",
                    "link": "2",
                },
                {
                    "id": 5,
                    "text": "On l'ouvre !",
                    "link": "6",
                },
            ],
        },
        "6": {
            "context": "Vous êtes riches, Bravo !",
            "buttons": [
                {
                    "id": 5,
                    "text": "Terminer",
                    "link": "-1",
                },
            ],
        },
        "7": {
            "context": "Une chauve-souris s'envole vers l'extérieur de la caverne, que faites-vous ?",
            "buttons": [
                {
                    "id": 1,
                    "text": "On sort avec la chauve-souris",
                    "link": "3",
                },
                {
                    "id": 2,
                    "text": "On continue de fouiller",
                    "link": "2",
                },
            ],
        },
        "8": {
            "context": "Une carcasse de chevreuil est étendue au fond du ruisseau, que faites-vous ?",
            "buttons": [
                {
                    "id": 1,
                    "text": "On fouille la carcasse",
                    "link": "9",
                },
                {
                    "id": 2,
                    "text": "On continue de fouiller la caverne",
                    "link": "2",
                },
            ],
        },
        "9": {
            "context": "Des traces de crocs acérés montrent que cette carcasse a été dévorée par un loup, que faites-vous ?",
            "buttons": [
                {
                    "id": 1,
                    "text": "On avance dans la caverne ! si il ya un loup, nous le tuerons !",
                    "link": "4",
                },
                {
                    "id": 2,
                    "text": "On continue de fouiller la caverne",
                    "link": "2",
                },
                {
                    "id": 2,
                    "text": "Un loup ? Fuions !",
                    "link": "3",
                },
            ],
        }


    };

    $(function() {
        $('#send').click(function() {
            var messages = document.getElementById("messages");
            var msg = document.getElementById("message-content");
            var user = document.getElementById("user").innerHTML;
            messages.innerHTML = messages.innerHTML + "<strong>" + user + ": </strong>" + msg.value + "<br>";
            messages.scrollTop = messages.scrollHeight - messages.clientHeight;
            msg.value = "";
            $.ajax({
                url : "/game/chat.php",
                type : "GET",
                data : {"pseudo": user,"message": msg},
            });    
        });  
    });

    function reload(){
        setTimeout(function(){
            var chat_id = document.getElementById("chat-id").innerHTML;
            console.log(chat_id);
            var premierID = $('#messages p:first').attr('id');
            $.ajax({
                url : "/game/chat/" + chat_id + "/getChat", // on passe l'id le plus récent au fichier de chargement
                type : "GET",
                data: premierID,
                success : function(html){
                    $('#messages').prepend(html);
                }
            });
            reload();
        }, 1000);

    }

    function fill_context(id){
        var element = document.getElementById("scenario-context");
        if(id == "-1"){
            element.innerHTML = "Terminé";
            return false;
        }
        element.innerHTML = "<p> " + COMPAIGN[id]["context"] + "</p>";
    }

    function fill_buttons(id){
        
        var element = document.getElementById("scenario-btn");
        var html = ""
        if(id == "-1"){
            element.innerHTML = "";
            return false;
        }
        COMPAIGN[id]["buttons"].forEach(function(item){
            html = html + '<button class="scenario-btn btn btn-outline-primary btn-sm" id="'+ item["id"]+ '" onclick="fill_game_scenario(' + item["link"] + ')">' + item["text"] + '</button>';
        });
        element.innerHTML = html;
    }

    function fill_game_scenario(id){
        fill_context(id);
        fill_buttons(id); 
    }

    //reload();
    fill_game_scenario("1");
</script>

{% endblock %}
